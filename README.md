# SocArXiv Bluesky Bot

This project builds on the [Bluesky bot template](https://github.com/philnash/bsky-bot) provided by Phil Nash - big thanks! to automatically fetch new SocArXiv preprints via RSS and post summaries to Bluesky.

It uses TypeScript, the `@atproto/api`, and runs as a scheduled task.

---

## Reference

For general setup, environment variables and deployment, please refer to the original template which explain this in detail. This README focuses only on the logic and maintenance of this specific application. 

---

## What This Bot Does

* **Fetches ArXiv RSS feed**
  Uses [`rss-parser`](https://www.npmjs.com/package/rss-parser) to read from:
  `https://osfpreprints-feed.herokuapp.com/SocArXiv.rss`

* **Tracks already posted papers**
  Stores IDs of posted papers in `postedPapers.json` to avoid duplicates.

* **Formats Bluesky post text**
  For each new paper, creates a short post with the title and link.

* **Posts to Bluesky**
  Logs in using the configured Bluesky handle and password, then posts using the `@atproto/api`.

---

## Main Files and Logic

| File                 | Purpose                                                                               |
| -------------------- | ------------------------------------------------------------------------------------- |
| `src/config.ts`      | Loads environment variables for Bluesky login and service                             |
| `src/bot.ts`         | Handles Bluesky login and posting                                                     |
| `src/getPostText.ts` | Parses the RSS feed, filters out already-posted papers, and prepares post texts       |
| `src/index.ts`       | Main script: pulls new posts, sends them to Bluesky, and updates `postedPapers.json`  |
| `.github/workflows/post.yml` | GitHub Action that runs the bot automatically on schedule |

---

## Setup

The handle and the PW are set in the GitHub secrets of the repository (-> Settings ->secrets and variables -> actions). 
If you change the password or the handle of the bluesky accojunt you can just change the secrets there and the bot will continue to work.
Additionally there is the GH_PAT (GitHub personal access token) that is needed for the github actions to push the changes to the postedPapers.json file in order to save which papers have been posted.
This token can be generated in the general settings of the github account under settings/tokens and then needs to be copied into the secret. This token can only be generated by the owner of the repo.
Usually you do not need to change this token but in the case you want to, only the psydig account is able to do so.

1. **GitHub Secrets**:
   - `BSKY_HANDLE`: Bluesky handle
   - `BSKY_PASSWORD`: the app password for the bot
   - `GH_PAT`: GitHub personal access token (used for committing updates to `postedPapers.json`). 

Note, if you want to go back to run the bot manually look into the manual from Phil Nash, you will need to create an .env file with the passwords and the handle. 

2. **Dependencies**:

The .nvmrc file defines which Node.js version is used for the GitHub Actions (via the actions/setup-node step). If this version becomes outdated, it can be changed there. 
	
---

### Workflow details

- **Schedule**: runs every 30 minutes ("*/30 * * * *"). Check out https://crontab.guru to see how this works
  
- **What it does** (each run):
  1. Checks out the repository (with permission to push changes)
  2. Installs Node.js and dependencies
  3. Builds and runs the bot
  4. Updates the `postedPapers.json` file if new papers were posted
  5. Commits the updated file back to the repository to maintain state

---

## Maintenance Tips

- **Action failure emails**  
  Occasionally, you might receive an email saying that a GitHub Action failed.  
  This can happen for several reasons — for example, too many simultaneous requests or a temporary issue with the Bluesky API.  
  - If it happens just once or twice, there’s usually no need to worry.  
  - You can check the repository’s **Actions** tab to see all recent runs.  
    - If there are successful runs (green checkmarks) after the failed ones, everything has likely recovered.  
    - If you see repeated failures (red marks), it’s a sign that something needs attention.

- **Why repeated failures matter**  
  When a job fails partway (for example, after posting 5 papers but failing on the 6th), the bot doesn’t update the `postedPapers.json` file.  
  This means that on the next run, it will try to post the same papers again, leading to duplicates or spam.  
  That’s why persistent failures should be investigated and fixed.

- **How to pause or stop the bot**  
  To temporarily stop the bot from posting:
  - Delete or rename the workflow file `.github/workflows/post.yml`.  
  - Or change the cron schedule inside the workflow to something that effectively disables it (for example, `* * * */12 *`).

- **Handling problematic papers**  
  Sometimes the bot may fail because a specific paper (e.g., with an unusually long title) isn’t compatible with the Bluesky API.  
  To handle this:
  - Ideally, update the bot’s code to skip or handle such cases in the future.  
  - As a quick fix, you can manually add that paper’s identifier to `postedPapers.json`.  
    - Check the format of existing entries carefully.  
    - Copy the paper’s details from the RSS feed into the file to ensure it’s skipped in future runs.

- **Adjusting post limits**  
  Change the `MAX_POSTS_PER_RUN` setting in `getPostText.ts`.  
  Note: Bluesky may impose limits on how many posts an account can make in a certain time window.  
  If the bot tries to post too many, the GitHub Action may fail before updating the posted list, leading to repeated reposting.

- **Changing the feed source**  
  Update the `FEED_URL` value in `getPostText.ts` to switch to a different RSS feed.

- **Updating posting frequency**  
  Modify the cron schedule in `.github/workflows/post.yml` to adjust how often the bot runs (e.g., every 30 minutes, every hour).

- **Updating Bluesky account details**  
  Go to **Settings → Secrets and variables → Actions** in the GitHub repository and update the `BSKY_HANDLE` and `BSKY_PASSWORD` secrets.